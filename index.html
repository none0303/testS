<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>micro:bit Bluetooth 接続テスト</title>
</head>
<body>
  <h1>micro:bit 接続</h1>
  <button id="connect">接続</button>
  <input id="msg" type="text" placeholder="送信メッセージ">
  <button id="send">送信</button>
  <pre id="log"></pre>

  <script>
    let uartCharacteristic;
    const log = msg => document.getElementById("log").textContent += msg + "\n";

    document.getElementById("connect").addEventListener("click", async () => {
      try {
        const device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "BBC micro:bit" }],
          optionalServices: [ "6e400001-b5a3-f393-e0a9-e50e24dcca9e" ] // UART Service UUID
        });

        log("接続中: " + device.name);
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        uartCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e"); // TX

        const rxChar = await service.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e"); // RX
        await rxChar.startNotifications();
        rxChar.addEventListener("characteristicvaluechanged", event => {
          const decoder = new TextDecoder();
          const data = decoder.decode(event.target.value);
          log("受信: " + data);
        });

        log("接続完了！");
      } catch (err) {
        log("エラー: " + err);
      }
    });

    document.getElementById("send").addEventListener("click", async () => {
      if (!uartCharacteristic) {
        log("未接続です");
        return;
      }
      const encoder = new TextEncoder();
      const msg = document.getElementById("msg").value;
      await uartCharacteristic.writeValue(encoder.encode(msg + "\n"));
      log("送信: " + msg);
    });
  </script>
</body>
</html>
